---
title: "task5 - Цзян Чжэнхуа"
output: html_document
date: "2024-03-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## task5(Вариант13)

Сначала считайте данные из файла csv и преобразуйте их в форму временного ряда.

```{r}
setwd("C:\\Users\\lenovo\\Desktop\\时间序列分析\\tsa5")
dat <- read.csv("TrainingData.csv")
dat <- dat[complete.cases(dat), ]

x <- ts(dat$Значение,start = c(2017,1),frequency = 12)
plot(x)
```

На основании предыдущих результатов была определена наиболее адекватная модель ARMA.

```{r}
x.fit <- arima(x,order = c(1,0,0),seasonal = list(order = c(0,0,1),period=12),method = "ML")
```


### Оцените эту модель

```{r}
library("lmtest")
x.fit
coeftest(x.fit)
```

Эта модель имеет наименьшее значение AIC,AIC = 101.26.

### Проверьте гипотезу, что остатки от удаления ARMA модели гетероскедастичны методом Engle на задержке 12.

```{r}
library(aTSA)
# Engle-test
arch.test(x.fit)
```

На основании полученных результатов. Первый тест не отвергает гипотезу о белом шуме на всех задержках.Второй тест не отвергает гипотезы о белом шуме на всех задержках, начиная с 5. Таким образом, гетероскедастичность в остатках при задержке 12 отсутствует.

### Оценить и выбрать простым перебором по критерию AIC оптимальную sGARCH модель порядка от (0,1) до (2,2), модель для среднего взять ARMA модель, порядки которой были определены в прошлом тесте.

```{r}
library(rugarch)

residuals <- x.fit$residuals

best_aic <- Inf
best_model <- NULL
best_order <- c(0, 0)

# Iterate over the GARCH order
for (p in 0:2) {
  for (q in 1:2) {
    spec <- ugarchspec(mean.model = list(armaOrder = c(0, 0)),
                       variance.model = list(model = "sGARCH", garchOrder = c(p, q)),
                       distribution.model = "norm")
    # Fitting a GARCH model
    fit <- ugarchfit(residuals,spec = spec)
    # Getting the AIC of a model
    current_aic <- infocriteria(fit)[1]
    cat(sprintf("GARCH(%d,%d) model AIC: %f\n", p, q, current_aic))
    
    # Updating the best model
    if (current_aic < best_aic) {
      best_aic <- current_aic
      best_model <- fit
      best_order <- c(p, q)
    }
  }
}
```

Лучшая модель GARCH находится путем обхода всех моделей и сравнения значений AIC.

```{r}
cat("Best GARCH model order: (", best_order[1], ",", best_order[2], ")\n", sep = "")
cat("Best AIC: ", best_aic, "\n")
```

### По лучшей из моделей построить прогноз и доверительный интервал для прогноза уровня 0.95 на 12 интервалов времени вперед.

Используется наилучшая модель GARCH, полученная ранее, и делается прогноз.

```{r}
best_spec <- ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(0, 1)),
                       mean.model = list(armaOrder = c(0, 0)), distribution.model = "norm")
best_model <- ugarchfit(spec = best_spec, data = residuals)
n.ahead <- 12  
confidence.level <- 0.95  

# make forecasts
forecast <- ugarchforecast(best_model, n.ahead = n.ahead)

forecasted_values <- forecast@forecast$seriesFor
lower_bounds <- forecast@forecast$seriesFor - 1.96 * forecast@forecast$sigmaFor
upper_bounds <- forecast@forecast$seriesFor + 1.96 * forecast@forecast$sigmaFor

# Creating Data Frames
forecast_df <- data.frame(
  Time = 1:n.ahead,
  Forecast = as.vector(forecasted_values),
  Lower = as.vector(lower_bounds),
  Upper = as.vector(upper_bounds)
)

print(forecast_df)  
```

Нарисуйте график прогноза, где красная заштрихованная область указывает на 95%-ный доверительный интервал.

```{r}
library(ggplot2)

n <- length(x)
original_dates <- seq(as.Date("2017-01-01"), by = "month", length.out = n)
forecast_dates <- seq(from = max(original_dates) + 30, by = "month", length.out = n.ahead)

original_data_df <- data.frame(Date = original_dates, Value = as.vector(x))
forecast_df$Date <- forecast_dates

# Plotting raw data and forecasts
ggplot() +
  geom_line(data = original_data_df, aes(x = Date, y = Value, colour = "Original Data"), linewidth = 1) +
  geom_line(data = forecast_df, aes(x = Date, y = Forecast, colour = "Forecast"), linewidth = 1) +
  geom_ribbon(data = forecast_df, aes(x = Date, ymin = Lower, ymax = Upper, fill = "95% Confidence Interval"), alpha = 0.2) +
  labs(title = "Original Data and GARCH Forecast", x = "Date", y = "Value") +
  theme_minimal() +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_colour_manual(values = c("Original Data" = "blue", "Forecast" = "red")) +
  scale_fill_manual(values = c("95% Confidence Interval" = "red"), guide = guide_legend(override.aes = list(alpha = 1))) +
  guides(colour = guide_legend(override.aes = list(linewidth = 2)))
```
