#include "pt4.h"
#include "mpi.h"

void Solve()
{
    Task("MPI7Win22");
    int flag;
    MPI_Initialized(&flag);
    if (flag == 0)
        return;
    int rank, size;
    MPI_Comm_size(MPI_COMM_WORLD, &size);
    MPI_Comm_rank(MPI_COMM_WORLD, &rank);

    double* A = new double[size - 1];
    double* AA = new double[rank];
    int* B = new int[8];

    if (rank == 0)
    {
        for (int i = 0; i < size - 1; i++)
        {
            pt >> A[i];
        }
        for (int i = 0; i < size - 1; i++)
        {
            Show(A[i]);
        }

        for (int j = 0; j < 8; j++)
        {
            pt >> B[j];
        }
    }
    else
    {
        for (int i = 0; i < rank; i++)
        {
            pt >> AA[i];
            Show(AA[i]);
        }
    }

    MPI_Status s;

    MPI_Win win;
    int double_size = 8;
    MPI_Win_create(AA, rank * double_size, double_size, MPI_INFO_NULL, MPI_COMM_WORLD, &win);
    MPI_Win_fence(0, win);

    if (rank == 0)
    {
        for (int i = 0; i < 8; i++)
        {
            MPI_Accumulate(A, B[i], MPI_DOUBLE, B[i], 0, B[i], MPI_DOUBLE, MPI_SUM, win);
        }
    }
    MPI_Win_fence(0, win);

    if (rank == 0);

    else
    {
        for (int i = 0; i < rank; i++)
        {
            Show(AA[i]);
            pt << AA[i];
        }
    }
}
